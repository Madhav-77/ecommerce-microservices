syntax = "proto3";

package order;

// Order Service - Manages orders and order items
service OrderService {
  rpc PlaceOrder (PlaceOrderRequest) returns (Order); // High-level orchestration method
  rpc CreateOrder (CreateOrderRequest) returns (Order); // Low-level order creation
  rpc FindOrderById (FindOrderByIdRequest) returns (Order);
  rpc FindOrdersByUserId (FindOrdersByUserIdRequest) returns (OrderList);
  rpc UpdateOrderStatus (UpdateOrderStatusRequest) returns (Order);
  rpc CancelOrder (CancelOrderRequest) returns (Order);

  // Server Streaming RPC - Real-time order tracking
  rpc WatchOrderStatus (WatchOrderStatusRequest) returns (stream OrderStatusUpdate);

  // Bidirectional Streaming RPC - Interactive order tracking with queries
  rpc InteractiveOrderTracking (stream TrackingQuery) returns (stream TrackingResponse);
}

// Enums
enum OrderStatus {
  CREATED = 0;
  PAID = 1;
  FAILED = 2;
  PROCESSING = 3;
  SHIPPED = 4;
  OUT_FOR_DELIVERY = 5;
  DELIVERED = 6;
  CANCELLED = 7;
}

// Messages
message OrderItem {
  string id = 1;
  string product_id = 2;
  int32 quantity = 3;
  double price = 4;
}

message Order {
  string id = 1;
  string user_id = 2;
  OrderStatus status = 3;
  double total_amount = 4;
  repeated OrderItem items = 5;
  string created_at = 6;
}

message OrderList {
  repeated Order orders = 1;
  int32 total = 2;
}

message CreateOrderRequest {
  string user_id = 1;
  repeated OrderItemRequest items = 2;
}

message OrderItemRequest {
  string product_id = 1;
  int32 quantity = 2;
  double price = 3; // Price at time of order (fetched by Gateway from Product Service)
}

message FindOrderByIdRequest {
  string id = 1;
}

message FindOrdersByUserIdRequest {
  string user_id = 1;
  int32 page = 2;
  int32 limit = 3;
}

message UpdateOrderStatusRequest {
  string id = 1;
  OrderStatus status = 2;
}

message CancelOrderRequest {
  string id = 1;
}

// PlaceOrder - High-level orchestration request (no prices, Order Service fetches them)
message PlaceOrderRequest {
  string user_email = 1;
  repeated PlaceOrderItemRequest items = 2;
}

message PlaceOrderItemRequest {
  string product_id = 1;
  int32 quantity = 2;
}

// Server Streaming - Watch Order Status
message WatchOrderStatusRequest {
  string order_id = 1;
}

message OrderStatusUpdate {
  string order_id = 1;
  OrderStatus status = 2;
  string message = 3;  // Human-readable status message
  string timestamp = 4;
}

// Bidirectional Streaming - Interactive Order Tracking
enum QueryType {
  SUBSCRIBE = 0;       // Subscribe to order updates
  GET_LOCATION = 1;    // Ask for current location
  GET_ETA = 2;         // Ask for estimated delivery time
  GET_STATUS = 3;      // Ask for current status
  CANCEL_ORDER = 4;    // Request order cancellation
}

message TrackingQuery {
  string order_id = 1;
  QueryType type = 2;
  string message = 3;  // Optional text message
}

enum ResponseType {
  STATUS_UPDATE = 0;   // Automatic status update from server
  LOCATION = 1;        // Response to location query
  ETA = 2;             // Response to ETA query
  CONFIRMATION = 3;    // Confirmation of action
  ERROR = 4;           // Error response
}

message TrackingResponse {
  string order_id = 1;
  ResponseType type = 2;
  OrderStatus status = 3;  // Current order status
  string message = 4;      // Human-readable message
  string location = 5;     // Current location (for LOCATION type)
  string eta = 6;          // Estimated time (for ETA type)
  string timestamp = 7;
}
